<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hollow Cinema — Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-purple: #8A2BE2;
      --primary-purple-glow: rgba(138, 43, 226, 0.6);
      --dark-blue: #1a1a2e;
      --deep-indigo: #0c0a1d;
      --light-text: #e0e0e0;
      --highlight-blue: #483D8B;
      --card-bg: #1e1e3f;
      --border-color: #4a4a6a;
      --accent: #e50914;
    }

    * { box-sizing: border-box; }
    body { margin:0; font-family:'Poppins', system-ui, Arial; background:var(--deep-indigo); color:var(--light-text); }

    header { position:sticky; top:0; background:var(--dark-blue); padding:14px 28px; display:flex; align-items:center; justify-content:space-between; z-index:50; border-bottom:1px solid var(--border-color);} 
    .brand { display:flex; gap:12px; align-items:center; }
    .brand h1 { margin:0; font-size:18px; color:#fff; text-shadow:0 0 8px var(--primary-purple-glow);} 

    .container { max-width:1100px; margin:28px auto; padding:0 20px; }

    .top-row { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
    .panel { background:var(--card-bg); border:1px solid var(--border-color); border-radius:10px; padding:16px; }

    /* Reservation list */
    .reservations { width:64%; }
    .reservations .heading { display:flex; align-items:center; gap:10px; }
    .reservations .heading h2 { margin:0; font-size:18px; }
    .actions { margin-left:auto; display:flex; gap:8px; }
    .btn { background:var(--highlight-blue); color:#fff; padding:8px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
    .btn.ghost { background:transparent; border:1px solid var(--border-color); }

    .list { margin-top:12px; display:flex; flex-direction:column; gap:12px; }
    .reservation { display:flex; gap:12px; align-items:center; padding:12px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.03); }
    .reservation.unread { box-shadow:0 2px 10px rgba(138,43,226,0.06); border-left:4px solid var(--primary-purple); }
    .avatar { width:44px; height:44px; border-radius:8px; background:linear-gradient(135deg,var(--primary-purple),var(--highlight-blue)); display:flex; align-items:center; justify-content:center; font-weight:700; }

    .res-info { flex:1; }
    .res-meta { color:#bfc4ff; font-size:13px; display:flex; gap:8px; align-items:center; }
    .res-title { font-weight:700; margin:0 0 6px 0; font-size:15px; }

    .res-actions { display:flex; gap:8px; align-items:center; }
    .small-btn { background:transparent; border:1px solid var(--border-color); color:var(--light-text); padding:6px 10px; border-radius:8px; cursor:pointer; }

    /* Right column: manage movies/seats */
    .side { width:34%; display:flex; flex-direction:column; gap:12px; }
    .compact { display:flex; justify-content:space-between; align-items:center; }

    /* Modal */
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(6,6,12,0.6); z-index:200; }
    .modal.open { display:flex; }
    .modal-panel { width:720px; max-width:96%; background:linear-gradient(180deg,#131325,#1a1a2e); border-radius:12px; padding:18px; border:1px solid var(--border-color); }
    .modal-row { display:flex; gap:12px; }
    .kv { font-size:13px; color:#bfc4ff; }
    .modal-close { background:#222; border:1px solid var(--border-color); color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; }

    /* Seat grid in manager */
    .seat-grid { display:grid; grid-template-columns:repeat(6, 1fr); gap:8px; max-width:360px; margin-top:12px; }
    .seat { padding:8px 6px; text-align:center; border-radius:8px; background:#3b3b5a; cursor:pointer; font-weight:700; }
    .seat.unavailable { background:#2a2a4e; opacity:0.7; }
    .seat.selected { box-shadow:0 0 10px var(--primary-purple-glow); background:var(--primary-purple); }

    footer { text-align:center; padding:18px 0; color:#9aa; }

    @media (max-width: 980px){ .top-row{flex-direction:column} .reservations{width:100%} .side{width:100%} }
  </style>
</head>
<body>
  <header>
    <div class="brand"><h1>Hollow Cinema — Admin</h1></div>
    <div>
      <button class="btn" onclick="markAllRead()">Mark all as read</button>
    </div>
  </header>

  <div class="container">
    <div class="top-row">
      <div class="reservations panel">
        <div class="heading compact">
          <div style="display:flex;align-items:center;gap:10px;"><h2>Recent Reservations</h2><span id="newBadge" style="background:var(--accent);padding:6px 8px;border-radius:8px;font-size:12px;">0 new</span></div>
          <div class="actions">
            <button class="btn ghost" onclick="openMovieManager()">Manage Movies</button>
            <button class="btn" onclick="syncFromStorage()">Refresh</button>
          </div>
        </div>

        <div class="list" id="reservationList">
          <!-- populated by JS -->
        </div>
      </div>

      <aside class="side">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>Seat Manager</strong>
            <button class="small-btn" onclick="openSeatManager()">Open</button>
          </div>
          <p class="kv" style="margin:8px 0 0 0;">Manage availability per showing.</p>
        </div>

        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>Quick Stats</strong>
            <div id="totalReservations">0</div>
          </div>
          <div style="margin-top:10px; font-size:13px; color:#bfc4ff;">You can manage movies & seats with the buttons above.</div>
        </div>
      </aside>
    </div>
  </div>

  <!-- View Modal -->
  <div id="viewModal" class="modal" onclick="if(event.target===this) closeModal()">
    <div class="modal-panel" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Reservation Details</strong>
        <div>
          <button class="modal-close" onclick="closeModal()">Close</button>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div class="modal-row">
          <div style="flex:1">
            <div class="kv">Customer</div>
            <div id="v_name" style="font-weight:700;margin-bottom:8px;"></div>

            <div class="kv">Email</div>
            <div id="v_email" style="margin-bottom:8px;"></div>

            <div class="kv">Movie / Showtime</div>
            <div id="v_movie" style="margin-bottom:8px;"></div>

            <div class="kv">Seats</div>
            <div id="v_seats" style="margin-bottom:8px;"></div>
          </div>

          <div style="width:260px;padding-left:12px;border-left:1px solid var(--border-color)">
            <div class="kv">Booked</div>
            <div id="v_timeAgo" style="font-weight:700;margin-bottom:8px;"></div>

            <div class="kv">Reference</div>
            <div id="v_ref" style="margin-bottom:8px;"></div>

            <div class="kv">Capacity</div>
            <div id="v_capacity" style="margin-bottom:8px;"></div>

            <div style="margin-top:10px"><button class="btn" onclick="openSeatManagerForCurrent()">Manage Seats</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Seat Manager Modal -->
  <div id="seatManagerModal" class="modal" onclick="if(event.target===this) closeSeatManager()">
    <div class="modal-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Seat Manager</strong>
        <div>
          <button class="modal-close" onclick="closeSeatManager()">Close</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <label class="kv">Select Movie</label>
        <select id="sm_movie" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;background:#222;border:1px solid var(--border-color);color:var(--light-text);"></select>

        <label class="kv" style="margin-top:10px;">Select Showtime (date | time)</label>
        <select id="sm_showtime" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;background:#222;border:1px solid var(--border-color);color:var(--light-text);"></select>

        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
          <label class="kv">Capacity</label>
          <input id="sm_capacity" type="number" min="0" style="margin-left:auto;width:120px;padding:6px;border-radius:8px;background:#111;border:1px solid var(--border-color);color:var(--light-text);" />
        </div>

        <div id="sm_seats_container" style="margin-top:12px;display:flex;gap:18px;align-items:flex-start;">
          <div>
            <div class="kv">Seat map</div>
            <div id="sm_grid" class="seat-grid"></div>
          </div>
          <div style="flex:1">
            <div class="kv">Legend</div>
            <div style="display:flex;gap:8px;margin-top:8px;"><div class="seat">A1</div><div class="kv">Available</div></div>
            <div style="display:flex;gap:8px;margin-top:8px;"><div class="seat unavailable">A2</div><div class="kv">Unavailable</div></div>

            <div style="margin-top:18px;"><button class="btn" onclick="saveSeatConfig()">Save</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>© Hollow Cinema</footer>

  <script>
    /* ---------- Storage keys & sample data ---------- */
    const RES_KEY = 'hc_reservations';
    const MOV_KEY = 'hc_movies';

    // sample movie data with showtimes + seats map (will initialize if missing)
    const SAMPLE_MOVIES = [
      { title: 'Demon Slayer: The Infinity Castle', showtimes: [ { date: todayStr(), time: '05:00 PM' }, { date: todayStr(), time: '07:30 PM' } ] },
      { title: 'JUJUTSU KAISEN: Shibuya Incident', showtimes: [ { date: todayStr(), time: '02:30 PM' } ] }
    ];

    function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }

    function ensureMovieData(){
      const raw = localStorage.getItem(MOV_KEY);
      if (!raw){
        // Build structure: movie -> showKey -> {capacity, seats: {A1: true}} 
        const payload = {};
        SAMPLE_MOVIES.forEach(m => {
          payload[m.title] = {};
          m.showtimes.forEach(s => {
            const key = showKey(m.title, s.date, s.time);
            payload[m.title][key] = { capacity: 30, seats: generateDefaultSeats(), createdAt: Date.now() };
          });
        });
        localStorage.setItem(MOV_KEY, JSON.stringify(payload));
      }
    }

    function generateDefaultSeats(){
      // A-E rows, 6 cols
      const seats = {};
      ['A','B','C','D','E'].forEach(r=>{ for(let i=1;i<=6;i++){ seats[`${r}${i}`] = true; }});
      return seats;
    }

    /* ---------- Reservations handling ---------- */
    function loadReservations(){
      const raw = localStorage.getItem(RES_KEY);
      return raw ? JSON.parse(raw) : [];
    }

    function saveReservations(arr){ localStorage.setItem(RES_KEY, JSON.stringify(arr)); }

    function addReservation(res){
      const all = loadReservations();
      all.unshift(res);
      saveReservations(all);
      dispatchUpdate();
    }

    // Integration helper so your main site can call: window.receiveBooking({ name, email, movie, date, time, seats: ['A1'], reference })
    window.receiveBooking = function(booking){
      // normalize & append timestamp
      const now = Date.now();
      const payload = Object.assign({ id: 'r_'+now, time: now, read: false }, booking);
      addReservation(payload);

      // also mark seats unavailable in movie data
      markSeatsUnavailable(booking.movie, booking.date, booking.time, booking.seats || []);
      return payload.id;
    }

    /* ---------- mark seats ---------- */
    function markSeatsUnavailable(movieTitle, date, time, seats){
      ensureMovieData();
      const movies = JSON.parse(localStorage.getItem(MOV_KEY));
      const key = showKey(movieTitle, date, time);
      if (!movies[movieTitle]) movies[movieTitle] = {};
      if (!movies[movieTitle][key]) movies[movieTitle][key] = { capacity: 30, seats: generateDefaultSeats(), createdAt: Date.now() };
      seats.forEach(s => { if (movies[movieTitle][key].seats[s] !== undefined) movies[movieTitle][key].seats[s] = false; });
      localStorage.setItem(MOV_KEY, JSON.stringify(movies));
    }

    function showKey(title, date, time){ return `${date} | ${time}`; }

    /* ---------- Rendering ---------- */
    function timeAgo(ts){ const m = Math.floor((Date.now()-ts)/60000); return m<=0? 'Just now': (m===1? '1 minute ago': m+' minutes ago'); }

    function renderList(){
      const list = loadReservations();
      const container = document.getElementById('reservationList');
      container.innerHTML = '';
      let newCount = 0;
      list.forEach(r => {
        const div = document.createElement('div');
        div.className = 'reservation ' + (r.read? '':'unread');
        if (!r.read) newCount++;

        div.innerHTML = `
          <div class='avatar'>${initials(r.name)}</div>
          <div class='res-info'>
            <div class='res-title'>${r.movie} <span style='font-weight:600;color:#bbb'>— ${r.seats? r.seats.join(', '): ''}</span></div>
            <div class='res-meta'><span>${r.name}</span> · <span>${r.email}</span> · <span id='time-${r.id}'>${timeAgo(r.time)}</span></div>
          </div>
          <div class='res-actions'>
            <button class='small-btn' onclick="viewReservation('${r.id}')">View</button>
            <button class='small-btn' onclick="toggleRead('${r.id}')">${r.read? 'Unread':'Mark read'}</button>
          </div>`;

        container.appendChild(div);
      });
      document.getElementById('totalReservations').textContent = list.length;
      document.getElementById('newBadge').textContent = newCount+ ' new';
    }

    function initials(name){ return name.split(' ').map(x=>x[0]||'').slice(0,2).join('').toUpperCase(); }

    function syncFromStorage(){ renderList(); }

    /* ---------- Actions ---------- */
    function toggleRead(id){ const list = loadReservations(); const item = list.find(x=>x.id===id); if (item){ item.read = !item.read; saveReservations(list); renderList(); } }
    function markAllRead(){ const list = loadReservations(); list.forEach(i=> i.read = true); saveReservations(list); renderList(); }

    /* ---------- View modal ---------- */
    let currentViewed = null;
    function viewReservation(id){
      const list = loadReservations(); const item = list.find(x=>x.id===id); if(!item) return;
      currentViewed = item;
      item.read = true; saveReservations(list);
      document.getElementById('v_name').textContent = item.name || '-';
      document.getElementById('v_email').textContent = item.email || '-';
      document.getElementById('v_movie').textContent = (item.movie || '-') + ' • ' + (item.date || '') + ' ' + (item.time || '');
      document.getElementById('v_seats').textContent = (item.seats && item.seats.length) ? item.seats.join(', ') : '-';
      document.getElementById('v_timeAgo').textContent = timeAgo(item.time);
      document.getElementById('v_ref').textContent = item.reference || item.id;

      // capacity lookup
      ensureMovieData();
      const movies = JSON.parse(localStorage.getItem(MOV_KEY));
      const key = showKey(item.movie, item.date, item.time);
      let capacityText = '—';
      if (movies[item.movie] && movies[item.movie][key]){
        const cfg = movies[item.movie][key];
        const totalSeats = Object.keys(cfg.seats).length;
        const remaining = Object.values(cfg.seats).filter(v=>v).length;
        capacityText = `${remaining} / ${totalSeats} available`;
      }
      document.getElementById('v_capacity').textContent = capacityText;

      renderList();
      openModal();
    }

    function openModal(){ document.getElementById('viewModal').classList.add('open'); startTimeAgoTicker(); }
    function closeModal(){ document.getElementById('viewModal').classList.remove('open'); }

    /* ---------- Seat Manager ---------- */
    function openSeatManager(){ ensureMovieData(); populateMovieSelect(); document.getElementById('seatManagerModal').classList.add('open'); }
    function closeSeatManager(){ document.getElementById('seatManagerModal').classList.remove('open'); }

    function openSeatManagerForCurrent(){ closeModal(); openSeatManager();
      if (!currentViewed) return; setTimeout(()=>{
        document.getElementById('sm_movie').value = currentViewed.movie; populateShowtimes(); document.getElementById('sm_showtime').value = showKey(currentViewed.movie, currentViewed.date, currentViewed.time); loadSeatGrid();
      }, 120);
    }

    function populateMovieSelect(){
      ensureMovieData(); const movies = JSON.parse(localStorage.getItem(MOV_KEY));
      const sel = document.getElementById('sm_movie'); sel.innerHTML = '';
      Object.keys(movies).forEach(title=>{ const opt = document.createElement('option'); opt.value = title; opt.textContent = title; sel.appendChild(opt); });
      sel.onchange = populateShowtimes; populateShowtimes();
    }

    function populateShowtimes(){ const movies = JSON.parse(localStorage.getItem(MOV_KEY)); const sel = document.getElementById('sm_movie'); const title = sel.value; const showSel = document.getElementById('sm_showtime'); showSel.innerHTML = '';
      if (movies[title]){
        Object.keys(movies[title]).forEach(k=>{ const opt = document.createElement('option'); opt.value = k; opt.textContent = k; showSel.appendChild(opt); });
      }
      showSel.onchange = loadSeatGrid; loadSeatGrid();
    }

    function loadSeatGrid(){ const movies = JSON.parse(localStorage.getItem(MOV_KEY)); const title = document.getElementById('sm_movie').value; const key = document.getElementById('sm_showtime').value; const cfg = movies[title][key];
      document.getElementById('sm_capacity').value = cfg.capacity || Object.keys(cfg.seats).length;
      const grid = document.getElementById('sm_grid'); grid.innerHTML = '';
      Object.keys(cfg.seats).forEach(s=>{ const d=document.createElement('div'); d.className='seat '+(cfg.seats[s]? '':'unavailable'); d.textContent=s; d.onclick = ()=>{ cfg.seats[s] = !cfg.seats[s]; d.classList.toggle('unavailable'); d.classList.toggle('selected'); } ; grid.appendChild(d); });
    }

    function saveSeatConfig(){ const movies = JSON.parse(localStorage.getItem(MOV_KEY)); const title = document.getElementById('sm_movie').value; const key = document.getElementById('sm_showtime').value; const cap = parseInt(document.getElementById('sm_capacity').value)||0; movies[title][key].capacity = cap; // seats already mutated
      localStorage.setItem(MOV_KEY, JSON.stringify(movies)); alert('Seats saved'); }

    /* ---------- Utilities & boot ---------- */
    function dispatchUpdate(){ renderList(); }

    function startTimeAgoTicker(){ // update time labels every 15s
      if (window.__timeTicker) clearInterval(window.__timeTicker);
      window.__timeTicker = setInterval(()=>{ document.querySelectorAll('[id^="time-"]').forEach(el=>{ const id = el.id.replace('time-',''); const list = loadReservations(); const it = list.find(x=>x.id===id); if (it) el.textContent = timeAgo(it.time); }); if(document.getElementById('viewModal').classList.contains('open')){ const cur = currentViewed; if(cur) document.getElementById('v_timeAgo').textContent = timeAgo(cur.time); } }, 15000);
    }

    function initialsFallback(s){ return s? s.split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase() : 'U'; }

    function initials(name){ try{ return initialsFallback(name); }catch(e){return 'U'} }

    /* Initialize */
    ensureMovieData(); renderList(); startTimeAgoTicker();

    // expose a helper to create a demo booking quickly in console
    window.demoBooking = function(){ const id = window.receiveBooking({ name:'Jane Doe', email:'jane@example.com', movie:'Demon Slayer: The Infinity Castle', date: todayStr(), time:'05:00 PM', seats:['A1','A2'], reference: 'REF-'+Math.random().toString(36).slice(2,8) }); console.log('Added',id); };
  </script>
</body>
</html>
